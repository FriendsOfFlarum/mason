(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const n=flarum.core.compat["forum/app"];var s=t.n(n);const o=flarum.core.compat["common/Model"];var r=t.n(o);const a=flarum.core.compat["common/models/Discussion"];var i=t.n(a);const l=flarum.core.compat["common/models/Forum"];var c=t.n(l);function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}function d(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,u(t,e)}var f=function(t){function e(){for(var e,n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];return(e=t.call.apply(t,[this].concat(s))||this).content=r().attribute("content"),e.is_suggested=r().attribute("is_suggested"),e.sort=r().attribute("sort"),e.field=r().hasOne("field"),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/fof/mason/answers"+(this.exists?"/"+this.data.id:"")},e}(r());const h=flarum.core.compat["common/utils/computed"];var p=t.n(h),g=function(t){function e(){for(var e,n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];return(e=t.call.apply(t,[this].concat(s))||this).name=r().attribute("name"),e.description=r().attribute("description"),e.min_answers_count=r().attribute("min_answers_count"),e.max_answers_count=r().attribute("max_answers_count"),e.show_when_empty=r().attribute("show_when_empty"),e.user_values_allowed=r().attribute("user_values_allowed"),e.validation=r().attribute("validation"),e.icon=r().attribute("icon"),e.sort=r().attribute("sort"),e.deleted_at=r().attribute("deleted_at",r().transformDate),e.allAnswers=r().hasMany("allAnswers"),e.suggestedAnswers=r().hasMany("suggestedAnswers"),e.required=p()("min_answers_count",(function(t){return t>0})),e.multiple=p()("max_answers_count",(function(t){return t>1})),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/fof/mason/fields"+(this.exists?"/"+this.data.id:"")},e}(r());const v=flarum.core.compat["common/extend"],w=flarum.core.compat["common/components/DiscussionComposer"];var y=t.n(w);const b=flarum.core.compat["common/helpers/icon"];var A=t.n(b);const M=flarum.core.compat["common/utils/ItemList"];var _=t.n(M);const S=flarum.core.compat["common/Component"];var x=t.n(S);const F=flarum.core.compat["common/utils/classList"];var N=t.n(F);function I(t,e){return e||(e="sort"),t.sort((function(t,n){return t[e]()-n[e]()}))}function P(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,s=new Array(e);n<e;n++)s[n]=t[n];return s}var T=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.view=function(t){var e=t.attrs,n=e.field,o=e.answers,r=e.onchange,a=[];return(n.suggestedAnswers()||[]).forEach((function(t){-1!==o.findIndex((function(e){return void 0!==e&&e.id()===t.id()}))&&a.push(t.id())})),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",multiple:n.multiple(),onchange:function(t){for(var e,n=[],o=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return P(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?P(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var s=0;return function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t.target.options);!(e=o()).done;){var a=e.value;if(a.selected&&"none"!==a.value){var i=a.value;n.push(s().store.getById("mason-answers",i))}}r(n)}},!n.multiple()&&m("option",{value:"none",selected:0===a.length,disabled:n.required(),hidden:this.placeholderHidden(n)},this.selectPlaceholder(n)),I(n.suggestedAnswers()||[]).map((function(t){return m("option",{value:t.id(),selected:-1!==a.indexOf(t.id())},t.content())}))),A()("fas fa-caret-down",{className:"Select-caret"}))},n.placeholderHidden=function(t){return!s().forum.attribute("fof-mason.labels-as-placeholders")&&t.required()},n.selectPlaceholder=function(t){var e="";return s().forum.attribute("fof-mason.labels-as-placeholders")&&(e+=t.name(),t.required()&&(e+=" *"),e+=" - "),t.required()?e+=s().translator.trans("fof-mason.forum.answers.choose-option"):e+=s().translator.trans("fof-mason.forum.answers.no-option-selected"),e},e}(x()),O=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.oninit=function(e){var n=this;t.prototype.oninit.call(this,e),this.field=this.attrs.field,this.answers=this.attrs.answers,this.onchange=this.attrs.onchange,this.content="";var s=this.answers.filter((function(t){return void 0!==t&&t.field().id()===n.field.id()}));s.length&&(this.content=s[0].content())},n.view=function(){var t=this;return m("input",{className:"FormControl",required:this.field.required(),value:this.content,oninput:function(e){if(t.content=e.target.value,""===t.content)t.onchange([]);else{var n=s().store.createRecord("mason-answers",{attributes:{content:t.content},relationships:{field:{data:r().getIdentifier(t.field)}}});t.onchange([n])}},placeholder:this.fieldPlaceholder()})},n.fieldPlaceholder=function(){return s().forum.attribute("fof-mason.labels-as-placeholders")?this.field.name()+(this.field.required()?" *":""):""},e}(x());const q=flarum.core.compat["tags/utils/sortTags"];var C=t.n(q),j=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.oninit=function(e){var n=this;t.prototype.oninit.call(this,e),this.tags=s().store.all("tags"),this.selectedTags=[],this.attrs.discussion?(this.tags=this.tags.filter((function(t){return t.canAddToDiscussion()||-1!==n.attrs.discussion.tags().indexOf(t)})),this.selectedTags=this.attrs.discussion.tags()):this.tags=this.tags.filter((function(t){return t.canStartDiscussion()})),this.minPrimary=s().forum.attribute("minPrimaryTags"),this.maxPrimary=s().forum.attribute("maxPrimaryTags"),this.minSecondary=s().forum.attribute("minSecondaryTags"),this.maxSecondary=s().forum.attribute("maxSecondaryTags"),this.maxPrimary<=0&&(this.tags=this.tags.filter((function(t){return!t.isPrimary()}))),this.maxSecondary<=0&&(this.tags=this.tags.filter((function(t){return t.isPrimary()}))),this.tags=C()(this.tags),this.inputUuid=Math.random().toString(36).substring(2)},n.view=function(){var t,e=this;if(this.maxPrimary>1||this.maxSecondary>1)return m("div",{className:"Alert"},s().translator.trans("fof-mason.forum.tags.inadequate-settings"));var n=this.selectedTags.length?this.selectedTags.sort((function(t){return t.parent()?-1:1}))[0].id():null,o=this.inputUuid,r=this.fieldRequired();return m("div",{className:N()("Mason-Field Form-group",(t={},t["Mason-Field--label-as-placeholder"]=s().forum.attribute("fof-mason.labels-as-placeholders"),t))},m("label",{for:"fofMason-selectInput-"+o},this.fieldLabel()),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",id:"fofMason-selectInput-"+o,onchange:function(t){var n=t.target.value;if(e.selectedTags=[],"none"!==n){e.selectedTags.push(e.tags.find((function(t){return t.id()===n})));var s=e.selectedTags[0].parent();s&&e.selectedTags.push(s)}e.attrs.onchange(e.selectedTags)}},m("option",{value:"none",selected:0===this.selectedTags.length,disabled:r,hidden:this.placeholderHidden()},this.selectPlaceholder()),this.tags.map((function(t){var e=t.parent();return m("option",{value:t.id(),selected:t.id()===n},(e?e.name()+" | ":"")+t.name())})),","),A()("fas fa-caret-down",{className:"Select-caret"})))},n.fieldRequired=function(){return this.minPrimary>0||this.minSecondary>0},n.fieldLabel=function(){var t=s().forum.attribute("fof-mason.tags-field-name")||s().translator.trans("fof-mason.forum.tags.tags-label");return this.fieldRequired()&&(t+=" *"),t},n.placeholderHidden=function(){return!s().forum.attribute("fof-mason.labels-as-placeholders")&&this.fieldRequired()},n.selectPlaceholder=function(){var t="";return s().forum.attribute("fof-mason.labels-as-placeholders")&&(t+=this.fieldLabel()+" - "),this.fieldRequired()?t+=s().translator.trans("fof-mason.forum.answers.choose-option"):t+=s().translator.trans("fof-mason.forum.answers.no-option-selected"),t},e}(x()),D=function(t){function e(){return t.apply(this,arguments)||this}return d(e,t),e.prototype.view=function(){return m("div",{className:"Mason-Grid-Wrapper"},m("div",{className:"Mason-Grid"},(t=this.attrs.items,e=s().forum.attribute("fof-mason.column-count"),Array(Math.ceil(t.length/e)).fill(void 0).map((function(n,s){return t.slice(e*s,e+e*s)}))).map((function(t){return m("div",{className:"Mason-Row"},t.map((function(t){return m("div",Object.assign({className:"Mason-Column"},t))})))}))));var t,e},e}(x()),E=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.oninit=function(e){var n=this;t.prototype.oninit.call(this,e),this.fields=I(s().store.all("mason-fields")),this.answerToFieldIndex=[],this.fields.forEach((function(t){var e=t.suggestedAnswers();Array.isArray(e)?e.forEach((function(e){n.answerToFieldIndex[e.id()]=t.id()})):console.warn("[mason] Missing suggestedAnswers relationship for field",t)}))},n.view=function(){return m("div",{className:"Mason-Fields Mason-Fields--editor"},this.headItems().toArray(),m(D,{items:this.fieldItems().toArray()}))},n.updateSelection=function(t,e){var n=this,s=this.attrs.answers.filter((function(e){var s=n.answerToFieldIndex[e.id()];return void 0===s?e.field().id()!==t.id():s!==t.id()}));s=s.concat(e),this.attrs.onchange(s)},n.headItems=function(){var t=new(_());return s().forum.attribute("fof-mason.fields-section-title")&&t.add("title",m("h5",{className:"Mason-Field--title"},s().forum.attribute("fof-mason.fields-section-title"))),t},n.fieldItems=function(){var t=this,e=new(_());return s().forum.attribute("fof-mason.tags-as-fields")&&e.add("tags",m(j,{discussion:this.attrs.discussion,onchange:function(e){t.attrs.ontagchange&&t.attrs.ontagchange(e)}})),this.fields.forEach((function(n){var o,r,a={field:n,answers:t.attrs.answers,onchange:function(e){t.updateSelection(n,e)}};r=n.user_values_allowed()?m(O,a):m(T,a),e.add("field-"+n.id(),m("div",{class:N()("Mason-Field Form-group",(o={},o["Mason-Field--label-as-placeholder"]=s().forum.attribute("fof-mason.labels-as-placeholders"),o))},m("label",null,n.icon()?m("[",null,A()(n.icon())," "):null,n.name(),n.required()?" *":null),r,n.description()?m("div",{className:"helpText"},n.description()):null))})),e},e}(x());const R=flarum.core.compat["forum/utils/DiscussionControls"];var U=t.n(R);const B=flarum.core.compat["common/components/Button"];var H=t.n(B);const L=flarum.core.compat["common/components/Modal"];var k=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.answers=this.attrs.discussion.masonAnswers(),this.dirty=!1,this.processing=!1,this.tags=null},n.title=function(){return s().translator.trans("fof-mason.forum.answers-modal.edit-title",{title:m("em",null,this.attrs.discussion.title())})},n.content=function(){var t=this;return m("[",null,m("div",{className:"Modal-body"},m(E,{discussion:this.attrs.discussion,answers:this.answers,onchange:this.answersChanged.bind(this),ontagchange:function(e){t.tags=e,t.dirty=!0}})),m("div",{className:"Modal-footer"},m(H(),{className:"Button Button--primary",loading:this.processing,disabled:!this.dirty,onclick:this.saveAnswers.bind(this)},s().translator.trans("fof-mason.forum.answers-modal.save"))))},n.answersChanged=function(t){this.answers=t,this.dirty=!0},n.saveAnswers=function(){var t=this;this.processing=!0;var e={masonAnswers:this.answers};null!==this.tags&&(e.tags=this.tags);var n=s().store.createRecord("discussions");n.pushData({id:this.attrs.discussion.id()}),n.exists=!0,n.save({relationships:e}).then((function(){t.processing=!1,s().modal.close(),m.redraw()})).catch((function(e){throw t.processing=!1,e}))},e}(t.n(L)());const G=flarum.core.compat["common/components/DiscussionHero"];var z=t.n(G),J=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.fields=I(s().store.all("mason-fields")),this.discussion=this.attrs.discussion},n.view=function(){var t=this.headItems().toArray(),e=this.fieldsItems().toArray();return e.length||t.length&&!s().forum.attribute("fof-mason.hide-empty-fields-section")?m("div",{className:"Mason-Fields Mason-Fields--viewer"},t,m(D,{items:e})):m("div",null)},n.headItems=function(){var t=this,e=new(_());return this.discussion.canUpdateMasonAnswers()&&e.add("edit",m(H(),{className:"Button Mason-Fields--edit",icon:"fas fa-pen",onclick:function(){return s().modal.show(k,{discussion:t.discussion})}},s().translator.trans("fof-mason.forum.discussion-controls.edit-answers"))),s().forum.attribute("fof-mason.fields-section-title")&&e.add("title",m("h5",{className:"Mason-Field--title"},s().forum.attribute("fof-mason.fields-section-title"))),e},n.fieldsItems=function(){var t=this,e=new(_());return this.fields.forEach((function(n){var o=I((t.discussion.masonAnswers()||[]).filter((function(t){return t.field()&&t.field().id()===n.id()}))),r=o.map((function(t){return m("span",{className:"Mason-Inline-Answer"},t.content())}));if(0===o.length){if(!n.show_when_empty())return;r.push(m("em",{className:"Mason-Inline-Answer"},s().translator.trans("fof-mason.forum.post-answers.no-answer")))}e.add("field-"+n.id(),m("div",{className:"Mason-Field Form-group"},m("label",null,n.icon()?m("[",null,A()(n.icon())," "):null,n.name()),m("div",{className:"FormControl Mason-Inline-Answers"},r)))})),e},e}(x());const W=flarum.core.compat["common/components/CommentPost"];var $=t.n(W);const K=flarum.core.compat["common/components/DiscussionPage"];var Q=t.n(K);function V(t){return!!s().current.matches(Q())&&1===t.number()&&!s().forum.attribute("fof-mason.fields-in-hero")}s().initializers.add("fof-mason",(function(t){t.store.models["mason-fields"]=g,t.store.models["mason-answers"]=f,i().prototype.masonAnswers=r().hasMany("masonAnswers"),i().prototype.canSeeMasonAnswers=r().attribute("canSeeMasonAnswers"),i().prototype.canUpdateMasonAnswers=r().attribute("canUpdateMasonAnswers"),c().prototype.canFillMasonFields=r().attribute("canFillMasonFields"),y().prototype.masonAnswers=[],(0,v.extend)(y().prototype,"headerItems",(function(t){var e=this;s().forum.canFillMasonFields()&&t.add("mason-fields",m(E,{answers:this.masonAnswers,onchange:function(t){e.masonAnswers=t},ontagchange:function(t){e.composer.fields.tags=t}}))})),(0,v.extend)(y().prototype,"data",(function(t){s().forum.canFillMasonFields()&&(t.relationships=t.relationships||{},t.relationships.masonAnswers=this.masonAnswers)})),(0,v.extend)(z().prototype,"items",(function(t){this.attrs.discussion.canSeeMasonAnswers()&&s().forum.attribute("fof-mason.fields-in-hero")&&t.add("mason-fields",m(J,{discussion:this.attrs.discussion}))})),(0,v.extend)($().prototype,"oninit",(function(){var t=this;this.attrs.post.discussion().canSeeMasonAnswers()&&V(this.attrs.post)&&this.subtree.check((function(){return(t.attrs.post.discussion().masonAnswers()||[]).map((function(t){return t?JSON.stringify([t.id(),!!t.field()]):""})).join(",")}))})),(0,v.extend)($().prototype,"content",(function(t){if(this.attrs.post.discussion().canSeeMasonAnswers()&&V(this.attrs.post)){var e=t.findIndex((function(t){return t.attrs&&"Post-header"===t.attrs.className}));t.splice(-1===e?0:e+1,0,m(J,{discussion:this.attrs.post.discussion()}))}})),(0,v.extend)(U(),"moderationControls",(function(t,e){e.canUpdateMasonAnswers()&&t.add("mason-update-answers",m(H(),{icon:"fas fa-tag",onclick:function(){return s().modal.show(k,{discussion:e})}},s().translator.trans("fof-mason.forum.discussion-controls.edit-answers")))})),(0,v.override)(r(),"getIdentifier",(function(t,e){return e instanceof f&&!e.exists?{type:e.data.type,attributes:{content:e.data.attributes.content},relationships:{field:{data:r().getIdentifier(e.data.relationships.field)}}}:t(e)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map