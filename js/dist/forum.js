(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const s=flarum.core.compat["forum/app"];var n=t.n(s);const o=flarum.core.compat["common/Model"];var r=t.n(o);const a=flarum.core.compat["common/models/Discussion"];var i=t.n(a);const l=flarum.core.compat["common/models/Forum"];var c=t.n(l);function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}function d(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,u(t,e)}var f=function(t){function e(){for(var e,s=arguments.length,n=new Array(s),o=0;o<s;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).content=r().attribute("content"),e.is_suggested=r().attribute("is_suggested"),e.sort=r().attribute("sort"),e.field=r().hasOne("field"),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/fof/mason/answers"+(this.exists?"/"+this.data.id:"")},e}(r());const h=flarum.core.compat["common/utils/computed"];var p=t.n(h),g=function(t){function e(){for(var e,s=arguments.length,n=new Array(s),o=0;o<s;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).name=r().attribute("name"),e.description=r().attribute("description"),e.min_answers_count=r().attribute("min_answers_count"),e.max_answers_count=r().attribute("max_answers_count"),e.show_when_empty=r().attribute("show_when_empty"),e.user_values_allowed=r().attribute("user_values_allowed"),e.validation=r().attribute("validation"),e.icon=r().attribute("icon"),e.sort=r().attribute("sort"),e.deleted_at=r().attribute("deleted_at",r().transformDate),e.allAnswers=r().hasMany("allAnswers"),e.suggestedAnswers=r().hasMany("suggestedAnswers"),e.required=p()("min_answers_count",(function(t){return t>0})),e.multiple=p()("max_answers_count",(function(t){return t>1})),e}return d(e,t),e.prototype.apiEndpoint=function(){return"/fof/mason/fields"+(this.exists?"/"+this.data.id:"")},e}(r());const v=flarum.core.compat["common/extend"],w=flarum.core.compat["common/components/DiscussionComposer"];var y=t.n(w);const b=flarum.core.compat["common/helpers/icon"];var A=t.n(b);const M=flarum.core.compat["common/utils/ItemList"];var _=t.n(M);const S=flarum.core.compat["common/Component"];var x=t.n(S);const F=flarum.core.compat["common/utils/classList"];var N=t.n(F);function I(t,e){return e||(e="sort"),t.sort((function(t,s){return t[e]()-s[e]()}))}function P(t,e){(null==e||e>t.length)&&(e=t.length);for(var s=0,n=new Array(e);s<e;s++)n[s]=t[s];return n}var T=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.view=function(t){var e=t.attrs,s=e.field,o=e.answers,r=e.onchange,a=[];return(s.suggestedAnswers()||[]).forEach((function(t){-1!==o.findIndex((function(e){return void 0!==e&&e.id()===t.id()}))&&a.push(t.id())})),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",multiple:s.multiple(),onchange:function(t){for(var e,s=[],o=function(t,e){var s="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(s)return(s=s.call(t)).next.bind(s);if(Array.isArray(t)||(s=function(t,e){if(t){if("string"==typeof t)return P(t,e);var s=Object.prototype.toString.call(t).slice(8,-1);return"Object"===s&&t.constructor&&(s=t.constructor.name),"Map"===s||"Set"===s?Array.from(t):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?P(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){s&&(t=s);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t.target.options);!(e=o()).done;){var a=e.value;if(a.selected&&"none"!==a.value){var i=a.value;s.push(n().store.getById("mason-answers",i))}}r(s)}},!s.multiple()&&m("option",{value:"none",selected:0===a.length,disabled:s.required(),hidden:this.placeholderHidden(s)},this.selectPlaceholder(s)),I(s.suggestedAnswers()||[]).map((function(t){return m("option",{value:t.id(),selected:-1!==a.indexOf(t.id())},t.content())}))),A()("fas fa-caret-down",{className:"Select-caret"}))},s.placeholderHidden=function(t){return!n().forum.attribute("fof-mason.labels-as-placeholders")&&t.required()},s.selectPlaceholder=function(t){var e="";return n().forum.attribute("fof-mason.labels-as-placeholders")&&(e+=t.name(),t.required()&&(e+=" *"),e+=" - "),t.required()?e+=n().translator.trans("fof-mason.forum.answers.choose-option"):e+=n().translator.trans("fof-mason.forum.answers.no-option-selected"),e},e}(x()),O=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.field=this.attrs.field,this.answers=this.attrs.answers,this.onchange=this.attrs.onchange,this.content="";var n=this.answers.filter((function(t){return void 0!==t&&t.field().id()===s.field.id()}));n.length&&(this.content=n[0].content())},s.view=function(){var t=this;return m("input",{className:"FormControl",required:this.field.required(),value:this.content,oninput:function(e){if(t.content=e.target.value,""===t.content)t.onchange([]);else{var s=n().store.createRecord("mason-answers",{attributes:{content:t.content},relationships:{field:{data:r().getIdentifier(t.field)}}});t.onchange([s])}},placeholder:this.fieldPlaceholder()})},s.fieldPlaceholder=function(){return n().forum.attribute("fof-mason.labels-as-placeholders")?this.field.name()+(this.field.required()?" *":""):""},e}(x());const q=flarum.core.compat["tags/utils/sortTags"];var C=t.n(q),j=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.tags=n().store.all("tags"),this.selectedTags=[],this.attrs.discussion?(this.tags=this.tags.filter((function(t){return t.canAddToDiscussion()||-1!==s.attrs.discussion.tags().indexOf(t)})),this.selectedTags=this.attrs.discussion.tags()):this.tags=this.tags.filter((function(t){return t.canStartDiscussion()})),this.minPrimary=n().forum.attribute("minPrimaryTags"),this.maxPrimary=n().forum.attribute("maxPrimaryTags"),this.minSecondary=n().forum.attribute("minSecondaryTags"),this.maxSecondary=n().forum.attribute("maxSecondaryTags"),this.maxPrimary<=0&&(this.tags=this.tags.filter((function(t){return!t.isPrimary()}))),this.maxSecondary<=0&&(this.tags=this.tags.filter((function(t){return t.isPrimary()}))),this.tags=C()(this.tags),this.inputUuid=Math.random().toString(36).substring(2)},s.view=function(){var t,e=this;if(this.maxPrimary>1||this.maxSecondary>1)return m("div",{className:"Alert"},n().translator.trans("fof-mason.forum.tags.inadequate-settings"));var s=this.selectedTags.length?this.selectedTags.sort((function(t){return t.parent()?-1:1}))[0].id():null,o=this.inputUuid,r=this.fieldRequired();return m("div",{className:N()("Mason-Field Form-group",(t={},t["Mason-Field--label-as-placeholder"]=n().forum.attribute("fof-mason.labels-as-placeholders"),t))},m("label",{for:"fofMason-selectInput-"+o},this.fieldLabel()),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",id:"fofMason-selectInput-"+o,onchange:function(t){var s=t.target.value;if(e.selectedTags=[],"none"!==s){e.selectedTags.push(e.tags.find((function(t){return t.id()===s})));var n=e.selectedTags[0].parent();n&&e.selectedTags.push(n)}e.attrs.onchange(e.selectedTags)}},m("option",{value:"none",selected:0===this.selectedTags.length,disabled:r,hidden:this.placeholderHidden()},this.selectPlaceholder()),this.tags.map((function(t){var e=t.parent();return m("option",{value:t.id(),selected:t.id()===s},(e?e.name()+" | ":"")+t.name())})),","),A()("fas fa-caret-down",{className:"Select-caret"})))},s.fieldRequired=function(){return this.minPrimary>0||this.minSecondary>0},s.fieldLabel=function(){var t=n().forum.attribute("fof-mason.tags-field-name")||n().translator.trans("fof-mason.forum.tags.tags-label");return this.fieldRequired()&&(t+=" *"),t},s.placeholderHidden=function(){return!n().forum.attribute("fof-mason.labels-as-placeholders")&&this.fieldRequired()},s.selectPlaceholder=function(){var t="";return n().forum.attribute("fof-mason.labels-as-placeholders")&&(t+=this.fieldLabel()+" - "),this.fieldRequired()?t+=n().translator.trans("fof-mason.forum.answers.choose-option"):t+=n().translator.trans("fof-mason.forum.answers.no-option-selected"),t},e}(x()),D=function(t){function e(){return t.apply(this,arguments)||this}return d(e,t),e.prototype.view=function(){return m("div",{className:"Mason-Grid-Wrapper"},m("div",{className:"Mason-Grid"},(t=this.attrs.items,e=n().forum.attribute("fof-mason.column-count"),Array(Math.ceil(t.length/e)).fill(void 0).map((function(s,n){return t.slice(e*n,e+e*n)}))).map((function(t){return m("div",{className:"Mason-Row"},t.map((function(t){return m("div",Object.assign({className:"Mason-Column"},t))})))}))));var t,e},e}(x()),E=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.fields=I(n().store.all("mason-fields")),this.answerToFieldIndex=[],this.fields.forEach((function(t){var e=t.suggestedAnswers();Array.isArray(e)?e.forEach((function(e){s.answerToFieldIndex[e.id()]=t.id()})):console.warn("[mason] Missing suggestedAnswers relationship for field",t)}))},s.view=function(){return m("div",{className:"Mason-Fields Mason-Fields--editor"},this.headItems().toArray(),m(D,{items:this.fieldItems().toArray()}))},s.updateSelection=function(t,e){var s=this,n=this.attrs.answers.filter((function(e){var n=s.answerToFieldIndex[e.id()];return void 0===n?e.field().id()!==t.id():n!==t.id()}));n=n.concat(e),this.attrs.onchange(n)},s.headItems=function(){var t=new(_());return n().forum.attribute("fof-mason.fields-section-title")&&t.add("title",m("h5",{className:"Mason-Field--title"},n().forum.attribute("fof-mason.fields-section-title"))),t},s.fieldItems=function(){var t=this,e=new(_());return n().forum.attribute("fof-mason.tags-as-fields")&&e.add("tags",m(j,{discussion:this.attrs.discussion,onchange:function(e){t.attrs.ontagchange&&t.attrs.ontagchange(e)}})),this.fields.forEach((function(s){var o,r,a={field:s,answers:t.attrs.answers,onchange:function(e){t.updateSelection(s,e)}};r=s.user_values_allowed()?m(O,a):m(T,a),e.add("field-"+s.id(),m("div",{class:N()("Mason-Field Form-group",(o={},o["Mason-Field--label-as-placeholder"]=n().forum.attribute("fof-mason.labels-as-placeholders"),o))},m("label",null,s.icon()?m("[",null,A()(s.icon())," "):null,s.name(),s.required()?" *":null),r,s.description()?m("div",{className:"helpText"},s.description()):null))})),e},e}(x());const R=flarum.core.compat["forum/utils/DiscussionControls"];var U=t.n(R);const B=flarum.core.compat["common/components/Button"];var H=t.n(B);const L=flarum.core.compat["common/components/Modal"];var k=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.answers=this.attrs.discussion.masonAnswers(),this.dirty=!1,this.processing=!1,this.tags=null},s.title=function(){return n().translator.trans("fof-mason.forum.answers-modal.edit-title",{title:m("em",null,this.attrs.discussion.title())})},s.content=function(){var t=this;return m("[",null,m("div",{className:"Modal-body"},m(E,{discussion:this.attrs.discussion,answers:this.answers,onchange:this.answersChanged.bind(this),ontagchange:function(e){t.tags=e,t.dirty=!0}})),m("div",{className:"Modal-footer"},m(H(),{className:"Button Button--primary",loading:this.processing,disabled:!this.dirty,onclick:this.saveAnswers.bind(this)},n().translator.trans("fof-mason.forum.answers-modal.save"))))},s.answersChanged=function(t){this.answers=t,this.dirty=!0},s.saveAnswers=function(){var t=this;this.processing=!0;var e={masonAnswers:this.answers};null!==this.tags&&(e.tags=this.tags);var s=n().store.createRecord("discussions");s.pushData({id:this.attrs.discussion.id()}),s.exists=!0,s.save({relationships:e}).then((function(){t.processing=!1,n().modal.close(),m.redraw()})).catch((function(e){throw t.processing=!1,e}))},e}(t.n(L)());const G=flarum.core.compat["common/components/DiscussionHero"];var z=t.n(G),J=function(t){function e(){return t.apply(this,arguments)||this}d(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.fields=I(n().store.all("mason-fields")),this.discussion=this.attrs.discussion},s.view=function(){var t=this.headItems().toArray(),e=this.fieldsItems().toArray();return e.length||t.length&&!n().forum.attribute("fof-mason.hide-empty-fields-section")?m("div",{className:"Mason-Fields Mason-Fields--viewer"},t,m(D,{items:e})):m("div",null)},s.headItems=function(){var t=this,e=new(_());return this.discussion.canUpdateMasonAnswers()&&e.add("edit",m(H(),{className:"Button Mason-Fields--edit",icon:"fas fa-pen",onclick:function(){return n().modal.show(k,{discussion:t.discussion})}},n().translator.trans("fof-mason.forum.discussion-controls.edit-answers"))),n().forum.attribute("fof-mason.fields-section-title")&&e.add("title",m("h5",{className:"Mason-Field--title"},n().forum.attribute("fof-mason.fields-section-title"))),e},s.fieldsItems=function(){var t=this,e=new(_());return this.fields.forEach((function(s){var o=I((t.discussion.masonAnswers()||[]).filter((function(t){return t.field()&&t.field().id()===s.id()}))),r=o.map((function(t){return m("span",{className:"Mason-Inline-Answer"},t.content())}));if(0===o.length){if(!s.show_when_empty())return;r.push(m("em",{className:"Mason-Inline-Answer"},n().translator.trans("fof-mason.forum.post-answers.no-answer")))}e.add("field-"+s.id(),m("div",{className:"Mason-Field Form-group"},m("label",null,s.icon()?m("[",null,A()(s.icon())," "):null,s.name()),m("div",{className:"FormControl Mason-Inline-Answers"},r)))})),e},e}(x());const W=flarum.core.compat["common/components/CommentPost"];var $=t.n(W);const K=flarum.core.compat["common/components/DiscussionPage"];var Q=t.n(K);function V(t){return!!n().current.matches(Q())&&1===t.number()&&!n().forum.attribute("fof-mason.fields-in-hero")}n().initializers.add("fof-mason",(function(t){t.store.models["mason-fields"]=g,t.store.models["mason-answers"]=f,i().prototype.masonAnswers=r().hasMany("masonAnswers"),i().prototype.canSeeMasonAnswers=r().attribute("canSeeMasonAnswers"),i().prototype.canUpdateMasonAnswers=r().attribute("canUpdateMasonAnswers"),c().prototype.canFillMasonFields=r().attribute("canFillMasonFields"),(0,v.extend)(y().prototype,"headerItems",(function(t){var e=this;n().forum.canFillMasonFields()&&t.add("mason-fields",m(E,{answers:this.composer.fields.masonAnswers||[],onchange:function(t){e.composer.fields.masonAnswers=t},ontagchange:function(t){e.composer.fields.tags=t}}))})),(0,v.extend)(y().prototype,"data",(function(t){n().forum.canFillMasonFields()&&this.composer.fields.masonAnswers&&(t.relationships=t.relationships||{},t.relationships.masonAnswers=this.composer.fields.masonAnswers)})),(0,v.extend)(z().prototype,"items",(function(t){this.attrs.discussion.canSeeMasonAnswers()&&n().forum.attribute("fof-mason.fields-in-hero")&&t.add("mason-fields",m(J,{discussion:this.attrs.discussion}))})),(0,v.extend)($().prototype,"oninit",(function(){var t=this;this.attrs.post.discussion().canSeeMasonAnswers()&&V(this.attrs.post)&&this.subtree.check((function(){return(t.attrs.post.discussion().masonAnswers()||[]).map((function(t){return t?JSON.stringify([t.id(),!!t.field()]):""})).join(",")}))})),(0,v.extend)($().prototype,"content",(function(t){if(this.attrs.post.discussion().canSeeMasonAnswers()&&V(this.attrs.post)){var e=t.findIndex((function(t){return t.attrs&&"Post-header"===t.attrs.className}));t.splice(-1===e?0:e+1,0,m(J,{discussion:this.attrs.post.discussion()}))}})),(0,v.extend)(U(),"moderationControls",(function(t,e){e.canUpdateMasonAnswers()&&t.add("mason-update-answers",m(H(),{icon:"fas fa-tag",onclick:function(){return n().modal.show(k,{discussion:e})}},n().translator.trans("fof-mason.forum.discussion-controls.edit-answers")))})),(0,v.override)(r(),"getIdentifier",(function(t,e){return e instanceof f&&!e.exists?{type:e.data.type,attributes:{content:e.data.attributes.content},relationships:{field:{data:r().getIdentifier(e.data.relationships.field)}}}:t(e)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map