(()=>{var t={n:s=>{var e=s&&s.__esModule?()=>s.default:()=>s;return t.d(e,{a:e}),e},d:(s,e)=>{for(var n in e)t.o(e,n)&&!t.o(s,n)&&Object.defineProperty(s,n,{enumerable:!0,get:e[n]})},o:(t,s)=>Object.prototype.hasOwnProperty.call(t,s)};(()=>{"use strict";const s=flarum.core.compat["forum/app"];var e=t.n(s);const n=flarum.core.compat["common/Model"];var o=t.n(n);const r=flarum.core.compat["common/models/Discussion"];var a=t.n(r);const i=flarum.core.compat["common/models/Forum"];var c=t.n(i);function l(t,s){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,s){return t.__proto__=s,t},l(t,s)}function u(t,s){t.prototype=Object.create(s.prototype),t.prototype.constructor=t,l(t,s)}var d=function(t){function s(){for(var s,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(s=t.call.apply(t,[this].concat(n))||this).content=o().attribute("content"),s.is_suggested=o().attribute("is_suggested"),s.sort=o().attribute("sort"),s.field=o().hasOne("field"),s}return u(s,t),s.prototype.apiEndpoint=function(){return"/fof/mason/answers"+(this.exists?"/"+this.data.id:"")},s}(o());const f=flarum.core.compat["common/utils/computed"];var h=t.n(f),p=function(t){function s(){for(var s,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(s=t.call.apply(t,[this].concat(n))||this).name=o().attribute("name"),s.description=o().attribute("description"),s.min_answers_count=o().attribute("min_answers_count"),s.max_answers_count=o().attribute("max_answers_count"),s.show_when_empty=o().attribute("show_when_empty"),s.user_values_allowed=o().attribute("user_values_allowed"),s.validation=o().attribute("validation"),s.icon=o().attribute("icon"),s.sort=o().attribute("sort"),s.deleted_at=o().attribute("deleted_at",o().transformDate),s.allAnswers=o().hasMany("allAnswers"),s.suggestedAnswers=o().hasMany("suggestedAnswers"),s.required=h()("min_answers_count",(function(t){return t>0})),s.multiple=h()("max_answers_count",(function(t){return t>1})),s}return u(s,t),s.prototype.apiEndpoint=function(){return"/fof/mason/fields"+(this.exists?"/"+this.data.id:"")},s}(o());const g=flarum.core.compat["common/extend"],v=flarum.core.compat["common/components/DiscussionComposer"];var w=t.n(v);const y=flarum.core.compat["common/helpers/icon"];var b=t.n(y);const A=flarum.core.compat["common/utils/ItemList"];var M=t.n(A);const _=flarum.core.compat["common/Component"];var x=t.n(_);const F=flarum.core.compat["common/utils/classList"];var N=t.n(F);function S(t,s){return s||(s="sort"),t.sort((function(t,e){return t[s]()-e[s]()}))}function I(t,s){(null==s||s>t.length)&&(s=t.length);for(var e=0,n=new Array(s);e<s;e++)n[e]=t[e];return n}var P=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.view=function(t){var s=t.attrs,n=s.field,o=s.answers,r=s.onchange,a=[];return(n.suggestedAnswers()||[]).forEach((function(t){-1!==o.findIndex((function(s){return void 0!==s&&s.id()===t.id()}))&&a.push(t.id())})),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",multiple:n.multiple(),onchange:function(t){for(var s,n=[],o=function(t,s){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,s){if(t){if("string"==typeof t)return I(t,s);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?I(t,s):void 0}}(t))||s&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t.target.options);!(s=o()).done;){var a=s.value;if(a.selected&&"none"!==a.value){var i=a.value;n.push(e().store.getById("mason-answers",i))}}r(n)}},!n.multiple()&&m("option",{value:"none",selected:0===a.length,disabled:n.required(),hidden:this.placeholderHidden(n)},this.selectPlaceholder(n)),S(n.suggestedAnswers()||[]).map((function(t){return m("option",{value:t.id(),selected:-1!==a.indexOf(t.id())},t.content())}))),b()("fas fa-caret-down",{className:"Select-caret"}))},n.placeholderHidden=function(t){return!e().forum.attribute("fof-mason.labels-as-placeholders")&&t.required()},n.selectPlaceholder=function(t){var s="";return e().forum.attribute("fof-mason.labels-as-placeholders")&&(s+=t.name(),t.required()&&(s+=" *"),s+=" - "),t.required()?s+=e().translator.trans("fof-mason.forum.answers.choose-option"):s+=e().translator.trans("fof-mason.forum.answers.no-option-selected"),s},s}(x()),T=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.oninit=function(s){var e=this;t.prototype.oninit.call(this,s),this.field=this.attrs.field,this.answers=this.attrs.answers,this.onchange=this.attrs.onchange,this.content="";var n=this.answers.filter((function(t){return void 0!==t&&t.field().id()===e.field.id()}));n.length&&(this.content=n[0].content())},n.view=function(){var t=this;return m("input",{className:"FormControl",required:this.field.required(),value:this.content,oninput:function(s){if(t.content=s.target.value,""===t.content)t.onchange([]);else{var n=e().store.createRecord("mason-answers",{attributes:{content:t.content},relationships:{field:{data:o().getIdentifier(t.field)}}});t.onchange([n])}},placeholder:this.fieldPlaceholder()})},n.fieldPlaceholder=function(){return e().forum.attribute("fof-mason.labels-as-placeholders")?this.field.name()+(this.field.required()?" *":""):""},s}(x());const q=flarum.core.compat["tags/utils/sortTags"];var O=t.n(q),C=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.oninit=function(s){var n=this;t.prototype.oninit.call(this,s),this.tags=e().store.all("tags"),this.selectedTags=[],this.attrs.discussion?(this.tags=this.tags.filter((function(t){return t.canAddToDiscussion()||-1!==n.attrs.discussion.tags().indexOf(t)})),this.selectedTags=this.attrs.discussion.tags()):this.tags=this.tags.filter((function(t){return t.canStartDiscussion()})),this.minPrimary=e().forum.attribute("minPrimaryTags"),this.maxPrimary=e().forum.attribute("maxPrimaryTags"),this.minSecondary=e().forum.attribute("minSecondaryTags"),this.maxSecondary=e().forum.attribute("maxSecondaryTags"),this.maxPrimary<=0&&(this.tags=this.tags.filter((function(t){return!t.isPrimary()}))),this.maxSecondary<=0&&(this.tags=this.tags.filter((function(t){return t.isPrimary()}))),this.tags=O()(this.tags),this.inputUuid=Math.random().toString(36).substring(2)},n.view=function(){var t,s=this;if(this.maxPrimary>1||this.maxSecondary>1)return m("div",{className:"Alert"},e().translator.trans("fof-mason.forum.tags.inadequate-settings"));var n=this.selectedTags.length?this.selectedTags.sort((function(t){return t.parent()?-1:1}))[0].id():null,o=this.inputUuid,r=this.fieldRequired();return m("div",{className:N()("Mason-Field Form-group",(t={},t["Mason-Field--label-as-placeholder"]=e().forum.attribute("fof-mason.labels-as-placeholders"),t))},m("label",{for:"fofMason-selectInput-"+o},this.fieldLabel()),m("span",{className:"Select"},m("select",{className:"Select-input FormControl",id:"fofMason-selectInput-"+o,onchange:function(t){var e=t.target.value;if(s.selectedTags=[],"none"!==e){s.selectedTags.push(s.tags.find((function(t){return t.id()===e})));var n=s.selectedTags[0].parent();n&&s.selectedTags.push(n)}s.attrs.onchange(s.selectedTags)}},m("option",{value:"none",selected:0===this.selectedTags.length,disabled:r,hidden:this.placeholderHidden()},this.selectPlaceholder()),this.tags.map((function(t){var s=t.parent();return m("option",{value:t.id(),selected:t.id()===n},(s?s.name()+" | ":"")+t.name())})),","),b()("fas fa-caret-down",{className:"Select-caret"})))},n.fieldRequired=function(){return this.minPrimary>0||this.minSecondary>0},n.fieldLabel=function(){var t=e().forum.attribute("fof-mason.tags-field-name")||e().translator.trans("fof-mason.forum.tags.tags-label");return this.fieldRequired()&&(t+=" *"),t},n.placeholderHidden=function(){return!e().forum.attribute("fof-mason.labels-as-placeholders")&&this.fieldRequired()},n.selectPlaceholder=function(){var t="";return e().forum.attribute("fof-mason.labels-as-placeholders")&&(t+=this.fieldLabel()+" - "),this.fieldRequired()?t+=e().translator.trans("fof-mason.forum.answers.choose-option"):t+=e().translator.trans("fof-mason.forum.answers.no-option-selected"),t},s}(x()),j=function(t){function s(){return t.apply(this,arguments)||this}return u(s,t),s.prototype.view=function(){return m("div",{className:"Mason-Grid-Wrapper"},m("div",{className:"Mason-Grid"},(t=this.attrs.items,s=e().forum.attribute("fof-mason.column-count"),Array(Math.ceil(t.length/s)).fill(void 0).map((function(e,n){return t.slice(s*n,s+s*n)}))).map((function(t){return m("div",{className:"Mason-Row"},t.map((function(t){return m("div",Object.assign({className:"Mason-Column"},t))})))}))));var t,s},s}(x()),D=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.oninit=function(s){var n=this;t.prototype.oninit.call(this,s),this.fields=S(e().store.all("mason-fields")),this.answerToFieldIndex=[],this.fields.forEach((function(t){var s=t.suggestedAnswers();Array.isArray(s)?s.forEach((function(s){n.answerToFieldIndex[s.id()]=t.id()})):console.warn("[mason] Missing suggestedAnswers relationship for field",t)}))},n.view=function(){return m("div",{className:"Mason-Fields Mason-Fields--editor"},this.headItems().toArray(),m(j,{items:this.fieldItems().toArray()}))},n.updateSelection=function(t,s){var e=this,n=this.attrs.answers.filter((function(s){var n=e.answerToFieldIndex[s.id()];return void 0===n?s.field().id()!==t.id():n!==t.id()}));n=n.concat(s),this.attrs.onchange(n)},n.headItems=function(){var t=new(M());return e().forum.attribute("fof-mason.fields-section-title")&&t.add("title",m("h5",{className:"Mason-Field--title"},e().forum.attribute("fof-mason.fields-section-title"))),t},n.fieldItems=function(){var t=this,s=new(M());return e().forum.attribute("fof-mason.tags-as-fields")&&s.add("tags",m(C,{discussion:this.attrs.discussion,onchange:function(s){t.attrs.ontagchange&&t.attrs.ontagchange(s)}})),this.fields.forEach((function(n){var o,r,a={field:n,answers:t.attrs.answers,onchange:function(s){t.updateSelection(n,s)}};r=n.user_values_allowed()?m(T,a):m(P,a),s.add("field-"+n.id(),m("div",{class:N()("Mason-Field Form-group",(o={},o["Mason-Field--label-as-placeholder"]=e().forum.attribute("fof-mason.labels-as-placeholders"),o))},m("label",null,n.icon()?m("[",null,b()(n.icon())," "):null,n.name(),n.required()?" *":null),r,n.description()?m("div",{className:"helpText"},n.description()):null))})),s},s}(x());const E=flarum.core.compat["forum/utils/DiscussionControls"];var R=t.n(E);const U=flarum.core.compat["common/components/Button"];var B=t.n(U);const H=flarum.core.compat["common/components/Modal"];var L=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.oninit=function(s){t.prototype.oninit.call(this,s),this.answers=this.attrs.discussion.masonAnswers(),this.dirty=!1,this.processing=!1,this.tags=null},n.title=function(){return e().translator.trans("fof-mason.forum.answers-modal.edit-title",{title:m("em",null,this.attrs.discussion.title())})},n.content=function(){var t=this;return m("[",null,m("div",{className:"Modal-body"},m(D,{discussion:this.attrs.discussion,answers:this.answers,onchange:this.answersChanged.bind(this),ontagchange:function(s){t.tags=s,t.dirty=!0}})),m("div",{className:"Modal-footer"},m(B(),{className:"Button Button--primary",loading:this.processing,disabled:!this.dirty,onclick:this.saveAnswers.bind(this)},e().translator.trans("fof-mason.forum.answers-modal.save"))))},n.answersChanged=function(t){this.answers=t,this.dirty=!0},n.saveAnswers=function(){var t=this;this.processing=!0;var s={masonAnswers:this.answers};null!==this.tags&&(s.tags=this.tags);var n=e().store.createRecord("discussions");n.pushData({id:this.attrs.discussion.id()}),n.exists=!0,n.save({relationships:s}).then((function(){t.processing=!1,e().modal.close(),m.redraw()})).catch((function(s){throw t.processing=!1,s}))},s}(t.n(H)());const k=flarum.core.compat["common/components/DiscussionHero"];var G=t.n(k),z=function(t){function s(){return t.apply(this,arguments)||this}u(s,t);var n=s.prototype;return n.oninit=function(s){t.prototype.oninit.call(this,s),this.fields=S(e().store.all("mason-fields")),this.discussion=this.attrs.discussion},n.view=function(){var t=this.headItems().toArray(),s=this.fieldsItems().toArray();return s.length||t.length&&!e().forum.attribute("fof-mason.hide-empty-fields-section")?m("div",{className:"Mason-Fields Mason-Fields--viewer"},t,m(j,{items:s})):m("div",null)},n.headItems=function(){var t=this,s=new(M());return this.discussion.canUpdateMasonAnswers()&&s.add("edit",m(B(),{className:"Button Mason-Fields--edit",icon:"fas fa-pen",onclick:function(){return e().modal.show(L,{discussion:t.discussion})}},e().translator.trans("fof-mason.forum.discussion-controls.edit-answers"))),e().forum.attribute("fof-mason.fields-section-title")&&s.add("title",m("h5",{className:"Mason-Field--title"},e().forum.attribute("fof-mason.fields-section-title"))),s},n.fieldsItems=function(){var t=this,s=new(M());return this.fields.forEach((function(n){var o=S((t.discussion.masonAnswers()||[]).filter((function(t){return t.field()&&t.field().id()===n.id()}))),r=o.map((function(t){return m("span",{className:"Mason-Inline-Answer"},t.content())}));if(0===o.length){if(!n.show_when_empty())return;r.push(m("em",{className:"Mason-Inline-Answer"},e().translator.trans("fof-mason.forum.post-answers.no-answer")))}s.add("field-"+n.id(),m("div",{className:"Mason-Field Form-group"},m("label",null,n.icon()?m("[",null,b()(n.icon())," "):null,n.name()),m("div",{className:"FormControl Mason-Inline-Answers"},r)))})),s},s}(x());const J=flarum.core.compat["common/components/CommentPost"];var W=t.n(J);const $=flarum.core.compat["common/components/DiscussionPage"];var K=t.n($);function Q(t){return!!e().current.matches(K())&&1===t.number()&&!e().forum.attribute("fof-mason.fields-in-hero")}e().initializers.add("fof-mason",(function(t){t.store.models["mason-fields"]=p,t.store.models["mason-answers"]=d,a().prototype.masonAnswers=o().hasMany("masonAnswers"),a().prototype.canSeeMasonAnswers=o().attribute("canSeeMasonAnswers"),a().prototype.canUpdateMasonAnswers=o().attribute("canUpdateMasonAnswers"),c().prototype.canFillMasonFields=o().attribute("canFillMasonFields"),(0,g.extend)(w().prototype,"headerItems",(function(t){var s=this;e().forum.canFillMasonFields()&&t.add("mason-fields",m(D,{answers:this.composer.fields.masonAnswers||[],onchange:function(t){s.composer.fields.masonAnswers=t},ontagchange:function(t){s.composer.fields.tags=t}}))})),(0,g.extend)(w().prototype,"data",(function(t){e().forum.canFillMasonFields()&&this.composer.fields.masonAnswers&&(t.relationships=t.relationships||{},t.relationships.masonAnswers=this.composer.fields.masonAnswers)})),(0,g.extend)(G().prototype,"items",(function(t){this.attrs.discussion.canSeeMasonAnswers()&&e().forum.attribute("fof-mason.fields-in-hero")&&t.add("mason-fields",m(z,{discussion:this.attrs.discussion}))})),(0,g.extend)(W().prototype,"oninit",(function(){var t=this;this.attrs.post.discussion().canSeeMasonAnswers()&&Q(this.attrs.post)&&this.subtree.check((function(){return(t.attrs.post.discussion().masonAnswers()||[]).map((function(t){return t?JSON.stringify([t.id(),!!t.field()]):""})).join(",")}))})),(0,g.extend)(W().prototype,"content",(function(t){if(this.attrs.post.discussion().canSeeMasonAnswers()&&Q(this.attrs.post)){var s=t.findIndex((function(t){return t.attrs&&"Post-header"===t.attrs.className}));t.splice(-1===s?0:s+1,0,m(z,{discussion:this.attrs.post.discussion()}))}})),(0,g.extend)(R(),"moderationControls",(function(t,s){s.canUpdateMasonAnswers()&&t.add("mason-update-answers",m(B(),{icon:"fas fa-tag",onclick:function(){return e().modal.show(L,{discussion:s})}},e().translator.trans("fof-mason.forum.discussion-controls.edit-answers")))})),(0,g.override)(o(),"getIdentifier",(function(t,s){return s instanceof d&&!s.exists?{type:s.data.type,attributes:{content:s.data.attributes.content},relationships:{field:{data:o().getIdentifier(s.data.relationships.field)}}}:t(s)}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map